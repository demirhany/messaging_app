<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/app.js"></script>
</head>
<body>
<div th:insert="components/header :: header"></div>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-3" id="users"></div>
        <div class="col-md-3">
            <div class="row">
                <button onclick="openChat()" class="btn btn-primary m-3">Start Chatting</button>
                <button onclick="closeChat()" class="btn btn-primary m-3">Close Chat</button>
            </div>
        </div>
        <div class="col-md-6">
            <div class="row m-3" id="chat"></div>
    </div>
</div>

<script>
    function fetchAllUsers() {
        fetch('/api/user', {
            method : 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })  .then(async response => {
            if (response.ok) {
                let userContainerElement = document.getElementById('users');
                userContainerElement.innerHTML = '';
                let users = await response.json();
                users.forEach(user => {
                    let userElement = document.createElement('div');
                    console.log(user.nick + " " + user.email);
                    userElement.innerHTML = user.email + ' - ' + user.nick;
                    userContainerElement.appendChild(userElement);
                })
            }
            else {
                let resBody = await response.text();
                showError('Login failed ' + response.status + ' ' + resBody);
            }
        })
            .catch(error => {
                showError('Error: ' + error);
                console.error('Error:', error);
            });
    }
    fetchAllUsers();
</script>

<script>
    function closeChat() {
        const chatElement = document.getElementById("main-content");
        chatElement.remove();
        disconnect();
        const scriptElement = document.getElementById("webSocketJs");
        if (scriptElement) {
            scriptElement.remove();
        }
    }

    function openChat() {
        event.preventDefault();
        const chatElement = document.getElementById("chat");
        const content =
            `<div id="main-content" className="container">
                <div className="row">
                    <div className="col-md-6">
                        <form className="form-inline">
                            <div className="form-group">
                                <label htmlFor="connect">WebSocket connection:</label>
                                <button id="connect" className="btn btn-default" type="submit" >Connect</button>
                                <button id="disconnect" className="btn btn-default" type="submit"
                                        disabled="disabled">Disconnect
                                </button>
                            </div>
                        </form>
                    </div>
                    <div className="col-md-6">
                        <form className="form-inline">
                            <div className="form-group">
                                <label htmlFor="name">What is your name?</label>
                                <input type="text" id="name" className="form-control" placeholder="Your name here..."/>
                            </div>
                            <button id="send" className="btn btn-default" type="submit">Send</button>
                        </form>
                    </div>
                </div>
                <div className="row">
                    <div className="col-md-12">
                        <table id="conversation" className="table table-striped">
                            <thead>
                            <tr>
                                <th>Greetings</th>
                            </tr>
                            </thead>
                            <tbody id="greetings">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        chatElement.innerHTML = content;

        const scriptElement = document.getElementById("webSocketJs");
        if (!scriptElement) {
            let webSocketScript = document.createElement('script');
            webSocketScript.setAttribute('src', '/js/webSocket.js');
            webSocketScript.setAttribute('id', 'webSocketJs');
            document.body.appendChild(webSocketScript);
        }
    }
</script>
</body>
</html>